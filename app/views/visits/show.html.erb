<%

# assumming if user has edit on one protocol, can have button , exclude the -1 scan_procedures 
# apply limit protocol  on create , edit in create form  
edit_count =current_user[:edit_low_scan_procedure_array].length
edit_count = edit_count -1 
%>
<% if edit_count > 0 %>
<span style="float:right"><%= link_to 'Edit MRI appt', edit_visit_path(@visit) %> | <%= link_to 'Vgroup', Vgroup.find(@appointment.vgroup_id) %></span>
<% end %>
<div id="visit_heading">
  <%=	link_to "&larr; Older".html_safe, @older_visit if @older_visit %>
  &nbsp;
  <h1><%= @enumbers.blank? ? @visit.rmr : @enumbers.collect{|e| e.enumber }.join(", ") %></h1>
  <p class="date"><%= @visit.date.to_s(:long) %></p>
  &nbsp;
  <%=	link_to "Newer &rarr;".html_safe, @newer_visit if @newer_visit %>
  <br />
  <p><%= @visit.path %></p>
</div>


<div id="leftcol" class="two_col_left">
  <h3>Summary:</h3>
  <table id="visit_status_table">
    <thead>
      <tr>
        <th>Transfer MRI</th>
        <th>Radiology Outcome</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <%= show_bool(@vgroup.transfer_mri) %>
        <%= show_rad_review(@visit.radiology_outcome) %>
      </tr>
    </tbody>
  </table>
  
  <div id="visit_details_note" class="sticky">
    <%= key_val_table("visit_details", {
      :MRI_appt_date => @visit.date,
      :scan_procedure => @visit.scan_procedures.sort_by(&:codename).collect {|sp| link_to(sp.codename, in_scan_procedure_path(sp))}.join(", ").html_safe,
      :Scan_number => @visit.scan_number,
      :enumber => @enumber.nil? ? nil : link_to(@visit.enrollment.enumber, @visit.enrollment),
      :Initials => @visit.initials_from_dicom_or_model,
      :RMR_Number => @visit.rmr,
      :Dicom_DVD => @visit.dicom_dvd == 'no' ? nil : @visit.dicom_dvd,
      :Assignee => @visit.user.nil? ? nil : @visit.user.username,
      :Scanner_source => @visit.scanner_source,
      :Created_by => @visit.created_by ? @visit.created_by.login : '',
      :Participant => @participant.nil? ? nil : link_to('view participant', @participant),
	  :Age_at_Visit => @visit.age_at_visit,
	 :MRI_Tech =>@visit.mritech.blank? ? "" : Employee.find(@visit.mritech).name,
	:Scan_Start_Time =>@visit.mristarttime.nil? ? nil : @visit.mristarttime.hour.to_s.rjust(2,'0')+":"+@visit.mristarttime.min.to_s.rjust(2,'0'),
	:Scan_End_Time =>@visit.mriendtime.nil? ? nil : @visit.mriendtime.hour.to_s.rjust(2,'0')+":"+@visit.mriendtime.min.to_s.rjust(2,'0'),
	:MRI_Fast_Completed => @visit.completedmrifast == 1 ? "Yes" : "No",
	:MRI_Fast_Total_Time => @visit.mrifasttotaltime.nil?  ? @visit.mrifasttotaltime_min.nil? ? nil : @visit.mrifasttotaltime.to_s+" hrs : "+@visit.mrifasttotaltime_min.to_s+" mins" :  @visit.mrifasttotaltime.to_s+" hrs : "+@visit.mrifasttotaltime_min.to_s+" mins" ,
	
    })  #:Archive_Dvd =>@visit.archivedvd,
    %>
  </div>



</div>



<div id="visit_status_report" class="two_col_right">

  <h3>Notes:</h3>
  <div id="notes" class="sticky">
    <%= RedCloth.new(@visit.notes.blank? ? "No notes entered for this visit" : @visit.notes).to_html.html_safe %>
  </div>
  <div id="notes" class="sticky">
    <%= RedCloth.new(@appointment.comment.blank? ? "" : @appointment.comment).to_html.html_safe %>
  </div>
<% @vital =  Vital.where("appointment_id in (?) ",@visit.appointment_id).first
 if !@vital.blank?
	 vital = Vital.find(@vital.id) 
	if ( ((vital.pulse.blank?? 911 :vital.pulse) < 911) or
		      ((vital.bp_systol.blank?? 911 :vital.bp_systol) < 911 ) or 
		        ( (vital.bp_diastol.blank?? 911 :vital.bp_diastol) < 911) or 
		           ((vital.bloodglucose.blank?? 911 :vital.bloodglucose) < 911)  )%>
	
<h4>Vitals:</h4>
<div id="vital" class="sticky">
     <%= vital.pulse==991 ?  "" :("Pulse: "+vital.pulse.to_s+"<br>").html_safe %>
     <%= vital.bp_systol==991 ?  "" :("BP Systol: "+vital.bp_systol.to_s+"<br>").html_safe %>
     <%= vital.bp_diastol==991 ?  "" :("BP Diastol: "+vital.bp_diastol.to_s+"<br>").html_safe %>
     <%= vital.bloodglucose==991 ?  "" :("Blood Glucose: "+vital.bloodglucose.to_s+"<br>").html_safe %>
</div>

<%    end 
  end %>
</div>


<br style="clear: both" /><br />


<h3>Images acquired during MRI appt:</h3>
<% if @image_datasets.empty? %>
  <p>No images associated with this MRI appt</p>
<% else %>
  <%= render(:partial => 'image_datasets/image_datasets', :locals => {:image_datasets => @image_datasets, :include_thumbnails => true, :edit_count => edit_count} ) %>
<% end %>

<!-- <h3>Check Radiology</h3> -->
<%= render(:partial => "lookup_radiology_button", :locals => {:rmr => @visit.rmr} ) %>
<br>
<div >
	
	<table  class="tabular_no_shade"><tr><th colsapn="4"  align="left">Scan Series</th><th align="left">Set</th><th align="left">Order</th><th align="left">LogFile Recorded</th></tr>
	<% @mriscantask.each do |mst|%>
	<% if !mst.image_dataset_id.blank?%>
	<tr><td colsapn="7" align = "left"><b><%= ImageDataset.find(mst.image_dataset_id).series_description %></b></td><tr>
	<% end %>
	<tr><td colsapn="4" align="left"><%= mst.lookup_scantask_id.blank? ? "" : LookupScantask.find(mst.lookup_scantask_id).description %>      </td>
		<td  align="left"><%= mst.lookup_set_id.blank? ? "" :LookupSet.find(mst.lookup_set_id).description %>      </td>
		<td align="left"><%= mst.task_order.try(:to_s)%>      </td>
		<td align="left"><%= mst.logfilerecorded==(-1) ? "Yes" : "No"%>      </td>
		</tr>
			<% if !mst.tasknote.blank? %>
			<tr><td colspan=7  align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Note: <%= mst.tasknote%> </td></tr>
			<% end %>
	<% @mriperformances = Mriperformance.where("mriscantask_id in (?)",mst.id)
	    @mriperformances.each do |mp| %>
		   <tr><td colspan="3" align="left">------Hit: <%= mp.hitpercentage.try(:to_s)%>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Acc: <%= mp.accuracypercentage.try(:to_s)%><td><td colspan="4"></tr>
		<% end%>
	 <% if !mst.p_file.blank? or !mst.reps.blank? or !mst.moved.blank? or !mst.eyecontact.blank? or !mst.preday.blank? or !mst.concerns.blank? or mst.has_concerns==(1) %>
		<tr>	
		<td align="right"><%= if !mst.p_file.blank?
			  "P-file: "+mst.p_file
			   end %>  </td>     
		<td align="right"><%= if !mst.reps.blank? 
			    "Reps: "+mst.reps.try(:to_s)
			   end %>  </td>
		<td align="right"><%= if !mst.moved.blank? 
			       mst.moved==(-1) ? "Moved: Yes" : "Moved: No" 
			   end%>      </td>
		<td align="right"><%= if !mst.eyecontact.blank?
			      mst.eyecontact ==(-1) ? "Eye Contact: Yes" : "Eye Contact: No"
			    end %>     </td>
		<td align="right"><%= if !mst.preday.blank?
			      "Preday: "+mst.preday.try(:to_s)
			 end %></td>		
		<td colspan="2" align="right">
		<% if !mst.concerns.blank? or mst.has_concerns==(1) %> 
		<%= mst.has_concerns==(1) ? "Has Concerns: " : "Concerns: "%> <%= mst.concerns %> 
		<% end %>  
		</tr>
	 <% end %>
	<% end %>
	</table>
</div>
<%= render(:partial => "visit_confirmation") %>

<%= content_tag :p, "STUDY UID: %s" % @visit.dicom_study_uid, :class => "uid" if @visit.dicom_study_uid %>