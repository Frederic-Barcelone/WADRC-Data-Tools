<%= form_for(@vgroup) do |f| %>
  <% if @vgroup.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@vgroup.errors.count, "error") %> prohibited this vgroup from being saved:</h2>

      <ul>
      <% @vgroup.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= f.label :vgroup_date %><br />
    <%= f.date_select :vgroup_date %>
  </div>
  <div class="field">
    <%= f.label :participant_id %><br />
<%= select(:vgroup, :participant_id, Enrollment.where(" participant_id is not null").all.sort_by(&:enumber).collect {|p| [ p.enumber, p.participant_id ] }, { :include_blank => "Select  a participant" }) %>   The participant may have mulitple enumbers --- not sure how to identify a participant. <br>Ignore the enumber associated with this participant when the enumber ( below) is not linked to this vgroup.<br><br>

  </div>

  <div class="field">
    <%= f.label :rmr %><br />
    <%= f.text_field :rmr %>
  </div><br>
<div class="field">
  <%= f.label :Compile_Folder %><br />
  <%= select :vgroup, :compile_folder, ["no", "yes", "n/a"] %>
</div><br>
  <div class="field">
    <%= f.label :note %><br />
    <%= f.text_area :note %>
  </div>
	<div id="scan_procedure_list">
	<ul>
	<% scan_procedure_array =current_user.edit_low_scan_procedure_array.split(' ')
	ScanProcedure.where(" scan_procedures.id in (?)",  scan_procedure_array).all.sort_by(&:codename).each do |scan_procedure| %>
		<li>
			<%#= f.fields_for scan_procedure do |scan_fields| %>
				<%#= f.check_box :scan_procedure_ids, {}, scan_procedure.id, :name => 'visit[scan_procedure_ids][]' %>
				<%#= f.label :scan_procedure_ids, scan_procedure.codename %>
			<%# end %>
		</li>
		<li>
			<%= check_box_tag "vgroup_scan_procedure_ids", scan_procedure.id, @vgroup.scan_procedures.include?(scan_procedure), :name => 'vgroup[scan_procedure_ids][]' %>
			<%= label_tag '', scan_procedure.codename %>
		</li>
	<% end %>
	</ul>
	</div>
	
	<%= f.fields_for :enrollments do |e| %>
	<p>
		<%= e.label :enumber %>
		<%= e.check_box :_destroy unless e.object.new_record?  %>
		<%= e.label :_destroy, "Remove?" unless e.object.new_record? %>
		<%= e.text_field_with_auto_complete :enumber, {},
			        { :method => :get, :url => enrollments_path(:format => :js), :param_name => 'search' } %>
	</p>
	<% end %>
	 When a vgroup is created, the selected participant will add all its enumbers to the vgroup. The extras can be deleted. Not sure how to add more enumbers, or to add an enumber which does not exist. Need to fix.
	<br><br>
  <div class="actions">
    <%= f.submit %>
  </div>
<% end %>

