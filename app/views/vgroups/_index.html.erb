<%# paginated = true unless paginated == false %>

<table class="tabular">
  
  <caption><%= pluralize(vgroups.total_count, 'Visits') %><%#= paginated ? pagination_info(vgroups) : pluralize(vgroups.length, 'Visits') %></caption>
  
  <thead>
    <tr>
      <th><span><%= sort_link @search, :vgroup_date %></span></th>
      <th><span><%= sort_link @search, :scan_procedures_codename, "Scan Procedure" %></span></th>
      <th><span><%= sort_link @search, :enrollments_enumber, "Enroll Number" %></span></th>
      <th><span><%= sort_link @search, :rmr %></span></th>
      <th><span class="vert">Appointments</span></th>
      <th><span class="vert">MRI Scan</span></th>
      <th><span class="vert">Pet Scan</span></th>
      <th><span class="vert">status</span></th>
      <th><span class="vert">status</span></th>
      <th><span class="vert">Lumbar Puncture</span></th>
      <th><span class="vert">NeuroP</span></th>
	  <th><span class="vert">Lab</span></th>
	  <th><span class="vert">Demographics</span></th>
      <th><span class="vert"><%= sort_link @search, :path, "Directory Path" %></span></th>
      <th><span class="vert"><%= sort_link @search, :transfer_mri %></span></th>
      <th><span class="vert"><%= sort_link @search, :transfer_pet %></span></th>
      <th><span class="vert"><%= sort_link @search, :radiology_outcome %></span></th>
      <th><span class="vert"><%= sort_link @search, :compile_folder %></span></th>
      <th><span class="vert"><%= sort_link @search, :conference %></span></th>
      <th></th>
    </tr>
  </thead>
  
  <tfoot><tr><td colspan=21>
		 <%= paginate vgroups %> 
		<%# if paginated %>
    	<%#= @vgroup_search.nil? ? will_paginate(vgroups) : will_paginate(vgroups, :params => { :vgroup_search => @vgroup_search }) %>
		<%# end %>
  </td></tr></tfoot>
  
  <tbody>
    <% vgroups.each do |vgroup| %>

   <%  @a =  Appointment.where("vgroup_id in (?)",vgroup.id)
        a_array =@a.to_a
       @visits = Visit.where("appointment_id in (?) ",a_array)
         visit = nil
         @visits.each do |v| 
	       visit = v
	     end
   # CHANGE TO GET rmr,enroll,scan_protocol from vgroup
       @petscans = Petscan.where("appointment_id in (?) ",a_array)
       @lumbarpunctures = Lumbarpuncture.where("appointment_id in (?) ",a_array)

     %>
      <tr>
        <td><%= link_to vgroup.vgroup_date.to_s(:datetime_military), vgroup %></td>
        <td><%= visit.blank? ? "None" : visit.scan_procedures.sort_by(&:codename).collect {|sp| link_to(sp.codename, in_scan_procedure_path(sp))}.join(", ").html_safe %></td>
        <td><%= visit.blank? ? "" :visit.enrollments.collect {|e| link_to(e.enumber, e) }.join(", ").html_safe %></td>
        <td><%= visit.blank? ? "" : visit.rmr %></td>
     <td><%= @a.blank? ?  "None" :	@a.collect{|sp| link_to("appt",appointment_path(sp))}.join(", ").html_safe %><br>
	CHANGE TO LINK TO vgroup page of appt</td>
    <td><%= @visits.blank? ?  "None" :	@visits.collect{|sp| link_to("mri scan",visit_path(sp))}.join(", ").html_safe %></td>
    <td><%= @petscans.blank? ?  "None" :	@petscans.collect{|sp| link_to("pet scan",petscan_path(sp))}.join(", ").html_safe %></td>
    <td><%= @petscans.blank? ?  "-" :	@petscans.collect{|sp| sp.completedpetscan==1 ? "C": (sp.enteredpetscan==1 ? "+": "-")}.join(", ").html_safe %></td>
    <td>New Petscan-- pass in vgroup_id</td>
	<td><%= @lumbarpunctures.blank? ?  "None" :	@lumbarpunctures.collect{|sp| link_to("lp",lumbarpuncture_path(sp))}.join(", ").html_safe %></td>
<!--       <td><= vgroup.appointments.blank? ? "None" : vgroup.appointmets.sort_by(&:codename).collect {|sp| sp.appointment_type}.join(", ").html_safe %></td>
 
        <td><= visit.scan_procedures.blank? ? "None" : visit.scan_procedures.sort_by(&:codename).collect {|sp| link_to(sp.codename, in_scan_procedure_path(sp))}.join(", ").html_safe %></td>
        <td><= visit.enrollments.collect {|e| link_to(e.enumber, e) }.join(", ").html_safe %></td>
        <td><= visit.rmr %></td>

-->
<!--        <td><= popup_note('peek', key_val_table('path_popup', { :Path => visit.path })) unless visit.path.blank? %></td>
        <= show_bool(visit.transfer_mri) %>
        <= show_bool(visit.transfer_pet) %>
        <= show_rad_review(visit.radiology_outcome) %>
        <= show_bool(visit.compile_folder) %>
        <= show_bool(visit.conference) %>
-->
        <td style="width: 6em;">
          <%= link_to 'show', vgroup %>
<% if edit_count > 0 %>
          <%= link_to 'edit', edit_vgroup_path(vgroup) %>
<% end %>
          <%#= link_to 'X', vgroup, :confirm => "Are you sure you want to delete this Visits?", :method => :delete %>
        </td>
      </tr>
    <% end %>
  </tbody>
  
</table>

 need to make links to each of the different appointments --- if none - link to new appointment - prepop that vgroup_id, type, display some extra properties from vgroup or children
                make children forms, add mri visit fields

