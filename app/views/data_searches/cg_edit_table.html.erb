<%
# check if tn_id had key columns defined
# check for cg_table ( edit) -- varchar version
# make if not there
# display all sved edits
# grey out key columns
# list key columns
# check if key columns are unique
# add delete row checkbox
@cg_tn = CgTn.find(params[:id])

if @cg_tn.table_type == 'column_group' and @cg_tn.editable_flag == "Y"
%>

cg_edit_table = <%= @cg_tn.common_name%>
<% # check if key is unique !!!!!!!!!!!%>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<small>enter "  <b>|</b> " to remove an individual cell's edit</small><br>

<% if !@key_cns.blank?%>
  <%= form_for 'cg_edit_table' do |f| %>
<%= hidden_field 'cg_edit_table','id' ,  :value=>params[:id]%>
<table class="tabular">
   <tr><th><small>Remove<br>data row</small></th>	<th><small>Remove<br>edit row</small></th>
	<% @cns.each do |cn| 
		      %>
	   <th><%= @cns_common_name_dict[cn]%> <br><small>-<%=cn%></small>
		<% if @key_cns.include?(cn)  %><br> key column <% end %></th>
    <% end %>
   </tr>
   <% v_cnt = 0
      @v_key.each do |k| %>
    <% 
    v_edit_in_row_flag ="N"
         @cns.each do |cn|
	       if  !@cg_edit_data_dict[k+cn].blank? and @cg_edit_data_dict[k+cn] != "|" 
		      v_edit_in_row_flag ="Y"
		   end
	     end
      %>
     <tr><td>
<%= hidden_field 'cg_edit_table','key][' ,  :value=>k %>
<%= check_box_tag "delete_data", "1", @cg_edit_data_dict[k+"delete_key_flag"] == "Y" ? TRUE : FALSE , :name => "cg_edit_table[delete_data]["+v_cnt.to_s+"]"   %></td>
     <td> <% if v_edit_in_row_flag =="Y" or @cg_edit_data_dict[k+"delete_key_flag"] == "Y"  %> <%= f.check_box 'delete_edit]['+v_cnt.to_s %> <% end %></td>
     <% v_cnt_cn = 0
        v_cg_data_row = "N"
      @cns.each do |cn|
	       if !@cg_data_dict[k+cn].blank?
		        v_cg_data_row = "Y"
		    end
	       %>
        <td  <% if  !@cg_edit_data_dict[k+cn].blank? and @cg_edit_data_dict[k+cn] != "|" %>
	          bgcolor="silver"
	         <%end%> >
	<small>(<%= @cg_data_dict[k+cn] %>)</small>
	    <% if !@key_cns.include?(cn) %>


	       <% if @cns_type_dict[cn] == "date"   # format YYYY-MM-DD %>
	     <%= f.text_field 'edit_col]['+k+']['+cn ,:size=>10 ,:onchange => "if (this.value != '|' && isValidDate_yyyy_mm_dd(this.value) ){alert('The field needs to be a date - YYYY-MM-DD.');this.value =''}",
        :value=>( !@cg_edit_data_dict[k+cn].blank? ?  ( @cg_edit_data_dict[k+cn] == "|" ?  @cg_data_dict[k+cn] :  @cg_edit_data_dict[k+cn] ):  @cg_data_dict[k+cn]) %>	
	       <% elsif @cns_type_dict[cn] == "integer"%>
	     <%= f.text_field 'edit_col]['+k+']['+cn ,:size=>10 ,:onchange => "if ( this.value != '|' &&  isNaN(this.value)){alert('The field needs to be all numeric.');this.value =''}",
        :value=>( !@cg_edit_data_dict[k+cn].blank? ?  ( @cg_edit_data_dict[k+cn] == "|" ?  @cg_data_dict[k+cn] :  @cg_edit_data_dict[k+cn] ):  @cg_data_dict[k+cn]) %>
	       <% elsif @cns_type_dict[cn] == "float"%>
	     <%= f.text_field 'edit_col]['+k+']['+cn ,:size=>10 ,:onchange => "if ( this.value != '|' && isNaN(this.value)){alert('The field needs to be all numeric.');this.value =''}",
        :value=>( !@cg_edit_data_dict[k+cn].blank? ?  ( @cg_edit_data_dict[k+cn] == "|" ?  @cg_data_dict[k+cn] :  @cg_edit_data_dict[k+cn] ):  @cg_data_dict[k+cn]) %>
	       <% else %>
	     <%= f.text_field 'edit_col]['+k+']['+cn ,:size=>10 ,
        :value=>( !@cg_edit_data_dict[k+cn].blank? ?  ( @cg_edit_data_dict[k+cn] == "|" ?  @cg_data_dict[k+cn] :  @cg_edit_data_dict[k+cn] ):  @cg_data_dict[k+cn]) %>
           <% end %>


       <% else %>
          <%=  @cg_edit_data_dict[k+cn]%>
       <% end %>


    </td>
       <%
         v_cnt_cn = v_cnt_cn + 1
      end %>
     <%  if v_cg_data_row == "Y"  %>
	     <%= hidden_field 'cg_edit_table','key_data][' ,  :value=>k %>         
       <%    end %>
     </tr>
   <% v_cnt = v_cnt +1 
      if v_cnt%25 == 0 %>
      <tr><th><small>Remove<br>data row</small></th>	<th><small>Remove<br>edit row</small></th>
	     <% @cns.each do |cn| %>
	          <th><small><%= @cns_common_name_dict[cn]%></small></th>
        <% end %>
      </tr>
    <% end %>
  <%  end%>
<% if (current_user.role == 'Admin_High' or current_user.role == 'Admin_Low' or @cg_tn.users.include?( current_user) ) and @cg_tn.editable_flag == "Y" %>
	<tr><td align="left" colspan="<%= @cns.size+2 %>"><%= submit_tag("save edits")%> | <%= link_to "Back", '/cg_tables'%></td></tr>
<% end %>
</table>
  <% end %>
<% else %>
 <B>There is no key column. Please add key column(s) to the cg table.</B>
<% end %>

<br>











<% end %>